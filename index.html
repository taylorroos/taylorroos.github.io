<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Endereços Local</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="styles.css" rel="stylesheet">
<style>
body { background-color: #f8f9fa; }
.container { max-width: 900px; margin-top: 30px; }
.card { margin-bottom: 10px; }
.form-label { margin-top: 10px; }
.map-link { text-decoration: none; }


.my-nav{
    align-items: center;
    justify-content: center;
    display: flex;
    flex-direction: column;
}

.my-nav-title{
    font-size: 35px;
    font-weight: bold;
    color:rgb(37, 36, 36);
    text-align: center;
    text-transform: uppercase;
}

.base-nav{
    /* background-color:#a80303; */
}


</style>
</head>
<body>
    <div class="base-nav">
        <div class="container my-nav">
            <img src="logo.jpg" alt="Logo" width="120" height="120" class="d-inline-block align-text-top"><br>
            <div class="my-nav-title">
                Corpo de Bombeiros Voluntários de Ipumirim
            </div>
        </div>
    </div>

<div class="container">
  <h3 class="mb-4 text-center">📍 Cadastro de Endereços</h3>

  <!-- Formulário -->
  <div id="cadastrarForm" class="collapse card p-3 mb-4">
    <h5>Adicionar / Editar Endereço</h5>
    <input id="editId" type="hidden">

    <label class="form-label">Moradores (um por linha, mínimo 1):</label>
    <textarea id="moradores" class="form-control" rows="3"></textarea>

    <label class="form-label">Telefones (um por linha, na mesma ordem dos moradores):</label>
    <textarea id="telefones" class="form-control" rows="3"></textarea>

    <label class="form-label">Link do Google Maps:</label>
    <input id="link_maps" class="form-control" placeholder="Cole o link aqui">

    <label class="form-label">Informações adicionais:</label>
    <textarea id="informacoes" class="form-control" rows="3"></textarea>

    <button id="btnSalvar" class="btn btn-success mt-3">💾 Salvar</button>
    <button id="btnCancelar" class="btn btn-secondary mt-3 d-none">Cancelar</button>
  </div>

  <!-- Busca -->
  <div class="input-group mb-3">
    <input id="busca" class="form-control" placeholder="Buscar por qualquer informação...">
    <button id="btnBuscar" class="btn btn-primary">🔍 Buscar</button>
  </div>

  <!-- Export / Import -->
  <div class="mb-3 d-flex gap-2">
    <button class="btn btn-success" type="button" data-bs-toggle="collapse" href="#cadastrarForm" aria-expanded="false" aria-controls="cadastrarForm">Cadastrar</button>
    <button id="btnExportar" class="btn btn-info">📤 Exportar JSON</button>
    <button id="btnImportar" class="btn btn-warning">📥 Importar JSON</button>
    <input type="file" id="inputImportar" class="d-none" accept=".json">
  </div>

  <!-- Lista de endereços -->
  <div id="listaEnderecos"></div>
</div>

<script>
const STORAGE_KEY = 'enderecos_db';

// ---------- Funções utilitárias ----------
function carregarEnderecos() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
}

function salvarEnderecos(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function gerarId() {
  return '_' + Math.random().toString(36).substr(2, 9);
}

function gerarLinkMaps(url) {
  if (!url) return '';
  return `<a href="${url}" target="_blank" class="map-link text-success fw-bold">🗺️ Ver no mapa</a>`;
}

function normalize(str) {
  return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function scoreMatch(entry, query) {
  const q = normalize(query.trim());
  if (!q) return 0;
  let score = 0;
  const text = [
    (entry.moradores || []).join(' '),
    (entry.telefones || []).join(' '),
    entry.link_maps || '',
    entry.informacoes || ''
  ].join(' ');
  const normText = normalize(text);

  if (normText.includes(q)) {
    score += 100;
  } else {
    const tokens = q.split(/\s+/);
    tokens.forEach(t => { if (normText.includes(t)) score += 25; });
  }
  return score;
}

// ---------- Renderização ----------
function renderizarLista(filtro = '') {
  const lista = document.getElementById('listaEnderecos');
  const enderecos = carregarEnderecos();
  const filtrados = enderecos
    .map(e => ({ ...e, score: scoreMatch(e, filtro) }))
    .filter(e => e.score > 0 || !filtro)
    .sort((a, b) => b.score - a.score);

  lista.innerHTML = filtrados.length
    ? filtrados.map(e => `
      <div class="card p-3">
        <h5>${(e.moradores || []).join(', ')}</h5>
        <p class="mb-1"><strong>Telefones:</strong> ${(e.telefones || []).join(', ')}</p>
        <p class="mb-1"><strong>Informações:</strong> ${e.informacoes || ''}</p>
        <p class="mb-2">${gerarLinkMaps(e.link_maps)}</p>
        <div class="d-flex gap-2">
          <button class="btn btn-warning btn-sm" onclick="editarEndereco('${e.id}')">✏️ Editar</button>
          <button class="btn btn-danger btn-sm" onclick="excluirEndereco('${e.id}')">🗑️ Excluir</button>
          <button class="btn btn-secondary btn-sm" onclick="copiarEndereco('${e.id}')">📋 Copiar</button>
        </div>
      </div>
    `).join('')
    : '<p class="text-center text-muted">Nenhum endereço encontrado.</p>';
}

// ---------- CRUD ----------
document.getElementById('btnSalvar').addEventListener('click', () => {
  const id = document.getElementById('editId').value;
  const moradores = document.getElementById('moradores').value.split('\n').map(s => s.trim()).filter(Boolean);
  const telefones = document.getElementById('telefones').value.split('\n').map(s => s.trim()).filter(Boolean);
  const link_maps = document.getElementById('link_maps').value.trim();
  const informacoes = document.getElementById('informacoes').value.trim();

  if (moradores.length < 1) return alert('Informe ao menos um morador.');
  if (telefones.length < 1) return alert('Informe ao menos um telefone.');

  const enderecos = carregarEnderecos();

  if (id) {
    const item = enderecos.find(e => e.id === id);
    if (item) {
      item.moradores = moradores;
      item.telefones = telefones;
      item.link_maps = link_maps;
      item.informacoes = informacoes;
      item.last_modified = new Date().toISOString();
    }
  } else {
    enderecos.push({
      id: gerarId(),
      moradores,
      telefones,
      link_maps,
      informacoes,
      last_modified: new Date().toISOString()
    });
  }

  salvarEnderecos(enderecos);
  limparFormulario();
  renderizarLista();
});

function editarEndereco(id) {
  const e = carregarEnderecos().find(x => x.id === id);
  if (!e) return;
  document.getElementById('editId').value = e.id;
  document.getElementById('moradores').value = (e.moradores || []).join('\n');
  document.getElementById('telefones').value = (e.telefones || []).join('\n');
  document.getElementById('link_maps').value = e.link_maps || '';
  document.getElementById('informacoes').value = e.informacoes || '';
  document.getElementById('btnSalvar').textContent = '💾 Atualizar';
  document.getElementById('btnCancelar').classList.remove('d-none');
}

function excluirEndereco(id) {
  if (!confirm('Deseja realmente excluir este endereço?')) return;
  const enderecos = carregarEnderecos().filter(e => e.id !== id);
  salvarEnderecos(enderecos);
  renderizarLista();
}

function copiarEndereco(id) {
    const e = carregarEnderecos().find(x => x.id === id);
    if (!e) return;

    // Estrutura de texto para WhatsApp
    const texto = 
    `🏠 Endereço
    Moradores: ${ (e.moradores || []).join(', ') }
    Telefones: ${ (e.telefones || []).join(', ') }
    Informações adicionais: ${ e.informacoes || '-' }
    Mapa: ${ e.link_maps || '-' }`;

    navigator.clipboard.writeText(texto)
        .then(() => alert('Informações copiadas para a área de transferência!'))
        .catch(() => alert('Erro ao copiar as informações.'));
}

function limparFormulario() {
  document.getElementById('editId').value = '';
  document.getElementById('moradores').value = '';
  document.getElementById('telefones').value = '';
  document.getElementById('link_maps').value = '';
  document.getElementById('informacoes').value = '';
  document.getElementById('btnSalvar').textContent = '💾 Salvar';
  document.getElementById('btnCancelar').classList.add('d-none');
}

document.getElementById('btnCancelar').addEventListener('click', limparFormulario);

// ---------- Busca ----------
document.getElementById('btnBuscar').addEventListener('click', () => {
  const filtro = document.getElementById('busca').value;
  renderizarLista(filtro);
});

document.getElementById('busca').addEventListener('keyup', e => {
  if (e.key === 'Enter') document.getElementById('btnBuscar').click();
});

// ---------- Exportar / Importar ----------
document.getElementById('btnExportar').addEventListener('click', () => {
  const data = carregarEnderecos();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'enderecos.json';
  a.click();
});

document.getElementById('btnImportar').addEventListener('click', () => {
  document.getElementById('inputImportar').click();
});

document.getElementById('inputImportar').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const importados = JSON.parse(evt.target.result);
      if (!Array.isArray(importados)) throw new Error('Arquivo inválido');

      const atuais = carregarEnderecos();
      const merge = [...atuais];

      importados.forEach(novo => {
        if (!novo.id) return;
        const i = merge.findIndex(a => a.id === novo.id);
        if (i >= 0) {
          const existente = merge[i];
          if (novo.last_modified && existente.last_modified) {
            if (new Date(novo.last_modified) > new Date(existente.last_modified)) {
              merge[i] = novo;
            }
          } else {
            merge[i] = novo;
          }
        } else {
          merge.push(novo);
        }
      });

      salvarEnderecos(merge);
      renderizarLista();
      alert('Importação concluída com sucesso!');
    } catch(err) {
      alert('Erro ao importar arquivo JSON.');
      console.error(err);
    }
  };
  reader.readAsText(file);
});

// ---------- Inicialização ----------
renderizarLista();
</script>
<script src="script.js"></script>
</body>
</html>
